"use strict";(()=>{var X=Object.create;var $=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var c=(s=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(s,{get:(e,r)=>(typeof require!="undefined"?require:e)[r]}):s)(function(s){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});var te=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of _(e))!re.call(s,o)&&o!==r&&$(s,o,{get:()=>e[o],enumerable:!(t=Y(e,o))||t.enumerable});return s};var O=(s,e,r)=>(r=s!=null?X(ee(s)):{},te(e||!s||!s.__esModule?$(r,"default",{value:s,enumerable:!0}):r,s));var m=(s,e,r,t)=>{for(var o=t>1?void 0:t?Y(e,r):e,i=s.length-1,a;i>=0;i--)(a=s[i])&&(o=(t?a(e,r,o):a(o))||o);return t&&o&&$(e,r,o),o},p=(s,e)=>(r,t)=>e(r,t,s);var n=(s,e,r)=>new Promise((t,o)=>{var i=v=>{try{u(r.next(v))}catch(Z){o(Z)}},a=v=>{try{u(r.throw(v))}catch(Z){o(Z)}},u=v=>v.done?t(v.value):Promise.resolve(v.value).then(i,a);u((r=r.apply(s,e)).next())});var cr=c("reflect-metadata"),W=O(c("express"));var H=c("tsyringe");var A=c("tsyringe");var k=c("tsyringe");var G=c("tsyringe");var B=c("@prisma/client"),L=new B.PrismaClient;var f=class s{constructor(e){this.id=e}static create(e){return this.validate(e),new s(e)}static validate(e){if(!e||isNaN(e))throw new Error("invalid id")}get value(){return this.id}};var h=class{save(e){return n(this,null,function*(){let r={name:e.value.name,email:e.value.email,password:e.value.passoword},{id:t}=yield L.user.create({data:r});return f.create(t)})}};h=m([(0,G.injectable)()],h);var j=class s{constructor(e,r,t){this.name=e;this.email=r;this.password=t}static create(e,r,t,o){return n(this,null,function*(){return t=yield o.encrypt(t),new s(e,r,t)})}static with(e,r,t){return n(this,null,function*(){return new s(e,r,t)})}get value(){return{name:this.name.value,email:this.email.value,passoword:this.password.value}}};var N=class s{constructor(e){this.name=e}static create(e){return this.validate(e),new s(e)}static validate(e){if(!/^[A-Za-zÀ-ÖØ-öø-ÿ]+(?: [A-Za-zÀ-ÖØ-öø-ÿ]+)*$/.test(e.trim()))throw new Error("invalid name")}get value(){return this.name}};var d=class s{constructor(e){this.email=e}static create(e){return this.validate(e),new s(e)}static validate(e){if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e.trim()))throw new Error("invalid email")}get value(){return this.email}};var l=class s{constructor(e){this.password=e}static create(e){return this.validate(e),new s(e)}static validate(e){let r=[{type:"size",regex:/^\S{8,}$/,message:"password must contain 8 characters"},{type:"alfa",regex:/[a-zA-Z]/,message:"password must contain letters"},{type:"number",regex:/\d/,message:"password must contain numbers"},{type:"uppercase",regex:/[A-Z]/,message:"password must contain at least one capital letter"},{type:"symbol",regex:/[\W_]/,message:"password must contain at least one symbol"}];for(let{type:t,regex:o,message:i}of r)if(!o.test(e.trim()))throw new Error(`/password ${t}/ ${i}`)}get value(){return this.password}};var M=c("tsyringe");var K=O(c("bcrypt"));var g=class{compare(e,r){return n(this,null,function*(){return yield K.default.compare(e.value,r.value)})}encrypt(e){return n(this,null,function*(){let t=yield K.default.hash(e.value,10);return l.create(t)})}};g=m([(0,M.injectable)()],g);var w=class{constructor(e,r){this.register=e;this.hasher=r}execute(e){return n(this,null,function*(){let r=N.create(e.name),t=d.create(e.email),o=l.create(e.password),i=yield j.create(r,t,o,this.hasher);return{id:(yield this.register.save(i)).value}})}};w=m([(0,k.injectable)(),p(0,(0,k.inject)(h)),p(1,(0,k.inject)(g))],w);var I=class{constructor(e){this.registerUser=e}execute(e,r,t){return n(this,null,function*(){try{let{name:o,email:i,password:a}=e.body,u=yield this.registerUser.execute({name:o,email:i,password:a});r.status(201).json({id:u.id,message:"user create success"})}catch(o){t(o)}})}};I=m([(0,A.injectable)(),p(0,(0,A.inject)(w))],I);var S=c("tsyringe");var b=class s{constructor(e,r,t){this.email=e;this.password=r;this.userId=t}static create(e,r,t){return new s(e,r,t)}compare(e,r,t){return n(this,null,function*(){if(!(yield t.compare(e,r)))throw new Error("incorrect password or email")})}get passwordEncode(){return this.password}get value(){var e;return{email:this.email.value,password:this.password.value,userId:(e=this.userId)==null?void 0:e.value}}};var Q=c("tsyringe");var x=class{list(e){return n(this,null,function*(){let r=e.value.email,t=yield L.user.findUnique({where:{email:r}});if(!t)return null;let o=d.create(t.email),i=l.create(t.password),a=f.create(t.id);return b.create(o,i,a)})}};x=m([(0,Q.injectable)()],x);var C=class s{constructor(e){this.key=e}static create(e){let r=e.KEY_SECRET;return this.validate(r),new s(r)}static validate(e){if(!e||e.trim().length===0)throw new Error("Secret key invalid or not found")}get value(){return this.key}};var T=class s{constructor(e){this.token=e}static create(e){return this.validate(e),new s(e)}static validate(e){if(!e||e.trim().length===0)throw new Error("Invalid token")}get value(){return this.token}};var J=O(c("jsonwebtoken")),y=class{genereteToken(e){let r=C.create(process.env),t=J.default.sign({userId:e.value.userId},r.value,{algorithm:"HS256"});return T.create(t)}verifyToken(e){let r=C.create(process.env),t=T.create(e);return J.default.verify(t.value,r.value)}};var R=c("tsyringe");var P=class{constructor(e,r,t){this.login=e;this.hasher=r;this.authService=t}execute(e){return n(this,null,function*(){let r=d.create(e.email),t=l.create(e.password),o=b.create(r,t),i=yield this.login.list(o);if(!i)throw new Error("incorrect password or email");return yield i.compare(t,i.passwordEncode,this.hasher),{token:this.authService.genereteToken(i).value}})}};P=m([(0,R.injectable)(),p(0,(0,R.inject)(x)),p(1,(0,R.inject)(g)),p(2,(0,R.inject)(y))],P);var U=class{constructor(e){this.loginUser=e}execute(e,r,t){return n(this,null,function*(){try{let{email:o,password:i}=e.body,{token:a}=yield this.loginUser.execute({email:o,password:i});r.status(201).setHeader("token",a).json({email:o,message:"user login success"})}catch(o){t(o)}})}};U=m([(0,S.injectable)(),p(0,(0,S.inject)(P))],U);var D=c("tsyringe");var E=class{constructor(e){this.authService=e}execute(e,r,t){try{let o=e.headers.token,{userId:i}=this.authService.verifyToken(o);r.locals.userId=i,t()}catch(o){let i={error:o.message};r.status(400).json(i)}}};E=m([(0,D.injectable)(),p(0,(0,D.inject)(y))],E);var q=class{static loading(e){let r=H.container.resolve(I),t=H.container.resolve(U),o=H.container.resolve(E);e.post("/register",r.execute.bind(r)),e.post("/login",t.execute.bind(t))}};var z=c("@prisma/client"),F=class{static catch(e,r,t,o){let i=400,a="Internal server error";e instanceof Error&&(a=e.message,i=400),e.code==="P2002"&&(a="/email duplicate / email already registered",i=409),e.code==="P2021"&&(a="/database/ database connection failure",i=500),e instanceof z.Prisma.PrismaClientUnknownRequestError&&(a="/database/ unknown Prisma error.",i=500),e instanceof z.Prisma.PrismaClientInitializationError&&(a="/database/  failed to connect to database.",i=500),e instanceof z.Prisma.PrismaClientRustPanicError&&(a="/database/  prism panicked.",i=500),t.status(i).json({error:a})}};var V=O(c("cors"));(function(){var o;let e=(0,W.default)(),r=Number((o=process.env.PORT)!=null?o:"8080"),t={exposedHeaders:["token"],allowedHeaders:["Content-Type","token","Authorization"],origin:["*"],methods:["POST"]};e.use(W.default.json()),e.use((0,V.default)(t)),q.loading(e),e.use(F.catch),e.listen(r,()=>{console.log(`server running on http://localhost:${r}`)})})();})();
